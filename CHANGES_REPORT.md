# Отчет об изменениях в интеграции WoodWOP Post Processor для FreeCAD

**Дата:** 2025-12-27  
**Версия:** 1.0

## Резюме

Реализована интеграция WoodWOP постпроцессора в FreeCAD с поддержкой вывода двух форматов (MPR и NC) для сравнения и исправления MPR постпроцессора. Добавлена автоматическая генерация отчета о проекте. Исправлена логика именования файлов на основе имени детали и Job.

## Измененные файлы

### 1. `/Users/user/Documents/freecad/.pixi/envs/default/Mod/CAM/Path/Post/scripts/woodwop_post.py`
**Источник:** `/Users/user/Documents/freecad/src/Mod/CAM/Path/Post/scripts/woodwop_post.py`

#### Основные изменения:

1. **Удален старый код создания файлов напрямую**
   - Удален блок кода, который создавал файлы `.mpr`, `.nc` и отчет напрямую через `open()`
   - Удален блок `else:` для stdout mode, который также создавал файлы напрямую

2. **Изменен возвращаемый тип функции `export()`**
   - **Было:** Функция возвращала строку (G-code) или `True` (bool)
   - **Стало:** Функция возвращает список кортежей: `[("mpr", mpr_content), ("nc", gcode_content)]`
   - Это позволяет FreeCAD создавать отдельные файлы для каждого формата

3. **Добавлена валидация возвращаемых значений**
   - Проверка типа `mpr_content` и `gcode_content` (должны быть строками)
   - Проверка типа результата перед возвратом (должен быть списком)
   - Проверка каждого элемента списка (должен быть кортежем из 2 элементов)
   - Финальная проверка на `bool` перед возвратом

4. **Добавлено расширенное логирование**
   - Логирование через `print()` и `FreeCAD.Console.PrintMessage()`
   - Логирование типов возвращаемых значений
   - Логирование пути к файлу модуля для отладки

5. **Удалена генерация отчета из `export()`**
   - Создание отчета перенесено в `Command.py` для выполнения после подтверждения имени файла в диалоге

#### Ключевые строки кода:
```python
# Возврат списка кортежей вместо строки
return [("mpr", mpr_content), ("nc", gcode_content)]

# Валидация перед возвратом
if not isinstance(result, list):
    # Обработка ошибки
    result = [("mpr", str(mpr_content) if mpr_content else ""), ("nc", str(gcode_content) if gcode_content else "")]
```

---

### 2. `/Users/user/Documents/freecad/.pixi/envs/default/Mod/CAM/Path/Post/Processor.py`
**Источник:** `/Users/user/Documents/freecad/src/Mod/CAM/Path/Post/Processor.py`

#### Основные изменения:

1. **Улучшена перезагрузка модуля в `WrapperPost.export()`**
   - **Было:** Использовался `importlib.reload()`, который не работал, если модуль не был в `sys.modules`
   - **Стало:** Модуль удаляется из `sys.modules` и загружается заново из файла для гарантии использования последней версии
   - Добавлено логирование пути к файлу модуля

2. **Добавлена обработка списка кортежей в `WrapperPost.export()`**
   - **Было:** Обрабатывался только традиционный возврат строки
   - **Стало:** Проверяется, является ли результат списком кортежей
   - Если да, каждый кортеж добавляется как отдельный subpart в `g_code_sections`
   - Это позволяет обрабатывать несколько форматов (MPR и NC)

3. **Добавлена обработка ошибок для неожиданных типов**
   - Обработка `bool`, `None` и других неожиданных типов
   - Сообщения об ошибках в консоль FreeCAD
   - Предотвращение падения при неверном типе

4. **Добавлено логирование в консоль FreeCAD**
   - Логирование типа результата от `export()`
   - Логирование количества элементов в списке
   - Логирование финального количества `g_code_sections`

#### Ключевые строки кода:
```python
# Удаление модуля из sys.modules для принудительной перезагрузки
if self.module_name in sys.modules:
    del sys.modules[self.module_name]

# Обработка списка кортежей
if isinstance(result, list) and len(result) > 0:
    if isinstance(result[0], tuple):
        for subpart_name, content in result:
            g_code_sections.append((subpart_name, content))
```

---

### 3. `/Users/user/Documents/freecad/.pixi/envs/default/Mod/CAM/Path/Post/Command.py`
**Источник:** `/Users/user/Documents/freecad/src/Mod/CAM/Path/Post/Command.py`

#### Основные изменения:

1. **Добавлена обработка нескольких subparts с одинаковым базовым именем**
   - **Проблема:** При создании нескольких файлов (MPR и NC) FreeCAD добавлял суффиксы `-1`, `-2` к именам файлов
   - **Решение:** Базовое имя сохраняется после первого subpart и переиспользуется для всех последующих
   - Это гарантирует, что оба файла имеют одинаковое базовое имя: `Part_Job.mpr` и `Part_Job.nc`

2. **Добавлена логика определения расширения файла по subpart**
   - Если subpart = "mpr", используется расширение `.mpr`
   - Если subpart = "nc", используется расширение `.nc`
   - Это позволяет FreeCAD правильно определять расширение файла

3. **Перенесено создание отчета из `woodwop_post.py`**
   - Создание отчета теперь происходит в `Command.py` после подтверждения всех имен файлов в диалоге
   - Отчет использует базовое имя из первого созданного файла
   - Отчет создается только для постпроцессора "woodwop"

4. **Улучшено логирование процесса создания файлов**
   - Логирование каждого этапа обработки subpart
   - Логирование сохранения и переиспользования базового имени
   - Логирование финальных имен файлов

#### Ключевые строки кода:
```python
# Сохранение базового имени для переиспользования
if base_filename_for_subparts is None:
    fname = next(generated_filename)
    base_filename_for_subparts, _ = os.path.splitext(fname)
else:
    # Переиспользование базового имени
    fname = base_filename_for_subparts + (os.path.splitext(next(generated_filename))[1] or '.nc')
```

---

### 4. `/Users/user/Documents/freecad/.pixi/envs/default/Mod/CAM/Path/Post/Utils.py`
**Источник:** `/Users/user/Documents/freecad/src/Mod/CAM/Path/Post/Utils.py`

#### Основные изменения:

1. **Добавлен метод `_get_post_processor_extension()`**
   - Динамически загружает модуль постпроцессора
   - Извлекает значение `FILE_EXTENSION` из модуля
   - Используется для установки правильного расширения по умолчанию в диалоге сохранения

2. **Добавлен метод `_get_part_name_from_job()`**
   - Извлекает имя детали из `Job.Model`, `Job.Base` или `Stock.Base`
   - Обрабатывает различные типы объектов FreeCAD (прямые объекты, списки, ссылки, группы)
   - Ищет объекты типа `Part::Feature`, `PartDesign::Body`, `App::Part`
   - Игнорирует невалидные имена типа `<group object>`
   - **Удаляет префикс "Model-" из имени детали**

3. **Улучшена логика генерации имени файла по умолчанию**
   - Приоритет: `part_name` + `job_name` > `PostProcessorOutputFile` > имя документа
   - Игнорируются невалидные имена (начинающиеся с `<` или `[`)
   - Используется расширение из постпроцессора, если доступно

4. **Добавлено глобальное логирование в файл**
   - Все сообщения `Path.Log` записываются в файл `freecad_postprocess_YYYYMMDD_HHMMSS.log`
   - Логирование каждого этапа генерации имени файла

#### Ключевые строки кода:
```python
# Удаление префикса "Model-"
if part_name.startswith('Model-'):
    part_name = part_name[6:]  # Remove "Model-" (6 characters)

# Приоритетная логика именования
if part_name and job_name:
    filename = f"{part_name}_{job_name}"
```

---

### 5. `/Users/user/Documents/freecad/.pixi/envs/default/Mod/CAM/Path/Tool/Gui/__init__.py`
**Источник:** `/Users/user/Documents/freecad/src/Mod/CAM/Path/Tool/Gui/__init__.py`

#### Основные изменения:

1. **Добавлен класс совместимости `BitLibrary`**
   - Решает проблему `ImportError: cannot import name 'BitLibrary' from 'Path.Tool.Gui'`
   - Позволяет старым аддонам (например, `btl`) работать с новой структурой FreeCAD
   - Позволяет аддонам monkey-patch атрибут `ToolBitLibrary`

#### Ключевые строки кода:
```python
# Backward compatibility for addons that use the old BitLibrary API
class BitLibrary:
    """
    Compatibility class for backward compatibility with old addons.
    The ToolBitLibrary attribute can be monkey-patched by addons like 'btl'.
    """
    ToolBitLibrary = None
```

---

## Удаленные файлы

### `/Users/user/Documents/freecad/woodwop post/woodwop_gcode_post.py`
- Удален по запросу пользователя
- Функциональность G-code генерации интегрирована в `woodwop_post.py`

---

## Результаты изменений

### До изменений:
- ❌ Постпроцессор возвращал только один формат (G-code как строка)
- ❌ Файлы создавались с неправильными именами (`<group object>.mpr`, `<group object>.nc`)
- ❌ Файлы создавались до подтверждения имени в диалоге
- ❌ Имена файлов содержали префикс "Model-"
- ❌ Не было отчета о проекте

### После изменений:
- ✅ Постпроцессор возвращает два формата (MPR и NC) как список кортежей
- ✅ Файлы создаются с правильными именами на основе имени детали и Job (`Part_Job.mpr`, `Part_Job.nc`)
- ✅ Файлы создаются только после подтверждения имени в диалоге
- ✅ Префикс "Model-" автоматически удаляется из имен файлов
- ✅ Автоматически создается отчет о проекте (`Part_Job_job_report.txt`)
- ✅ Оба файла имеют одинаковое базовое имя (без суффиксов `-1`, `-2`)

---

## Технические детали

### Архитектура решения:

1. **Множественные форматы:**
   - `woodwop_post.py` генерирует оба формата (MPR и NC)
   - Возвращает список кортежей: `[("mpr", mpr_content), ("nc", gcode_content)]`
   - `Processor.py` обрабатывает список и создает отдельные subparts
   - `Command.py` создает отдельные файлы для каждого subpart

2. **Именование файлов:**
   - `Utils.py` извлекает имя детали из Job
   - Удаляет префикс "Model-" из имени
   - Объединяет с именем Job: `{part_name}_{job_name}`
   - `Command.py` сохраняет базовое имя для переиспользования между subparts

3. **Создание отчета:**
   - Отчет создается в `Command.py` после подтверждения всех имен файлов
   - Использует базовое имя из первого созданного файла
   - Содержит все свойства Job для проверки корректности работы

---

## Файлы для сравнения

Для проверки корректности работы постпроцессора создаются два файла:
- `Part_Job.mpr` - WoodWOP MPR формат (основной формат)
- `Part_Job.nc` - Стандартный G-code формат (для сравнения)

Пользователь может сравнить содержимое этих файлов для исправления MPR постпроцессора.

---

## Логирование

Все операции логируются в файл:
- `freecad_postprocess_YYYYMMDD_HHMMSS.log` - детальный лог всех операций

Логи содержат:
- Процесс генерации имени файла
- Обработку каждого subpart
- Создание файлов
- Создание отчета

---

## Совместимость

- ✅ FreeCAD 1.2.0
- ✅ Python 3.11
- ✅ Обратная совместимость со старыми аддонами (через `BitLibrary`)

---

## Примечания

1. Все изменения синхронизированы между:
   - Установленной версией: `.pixi/envs/default/Mod/CAM/Path/Post/`
   - Исходным кодом: `src/Mod/CAM/Path/Post/`

2. Для применения изменений требуется перезапуск FreeCAD (не просто перезагрузка модуля).

3. Модуль `woodwop_post` принудительно перезагружается при каждом вызове для гарантии использования последней версии.

---

**Конец отчета**

