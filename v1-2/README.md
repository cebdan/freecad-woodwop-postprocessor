# WoodWOP MPR Post Processor for FreeCAD

A post processor for FreeCAD's Path workbench that generates WoodWOP MPR 4.0 format output for HOMAG CNC machines.

## Features

- Converts FreeCAD Path operations to WoodWOP MPR 4.0 format
- Supports contour elements (lines and arcs)
- Generates WoodWOP macros:
  - **Werkstck** - Workpiece definition
  - **BohrVert** - Vertical drilling
  - **Contourfraesen** - Contour milling/routing
  - **Pocket** - Pocket milling
  - **Comment** - Comments
- Auto-detects workpiece dimensions from FreeCAD Job
- Configurable coordinate precision
- Optional comment output

## Installation

### Method 1: Manual Installation

1. Locate your FreeCAD post processor directory:
   - **Linux**: `~/.local/share/FreeCAD/Macro/` or `/usr/share/freecad/Mod/Path/PathScripts/post/`
   - **macOS**: `~/Library/Application Support/FreeCAD/Macro/` or `/Applications/FreeCAD.app/Contents/Resources/Mod/Path/PathScripts/post/`
   - **Windows**: `%APPDATA%\FreeCAD\Macro\` or `C:\Program Files\FreeCAD\Mod\Path\PathScripts\post\`

2. Copy `woodwop_post.py` to the post processor directory

3. Restart FreeCAD

### Method 2: User Macro Directory

1. In FreeCAD, go to **Macro → Macros...**
2. Note the path shown at the top (this is your macro directory)
3. Copy `woodwop_post.py` to this directory
4. Restart FreeCAD

## Usage

### In FreeCAD Path Workbench

1. Create your tool paths in the Path workbench
2. Select your Job object
3. Go to **Path → Post Process**
4. In the Post Processor dropdown, select **woodwop_post**
5. Configure options if needed (see Arguments below)
6. Click **OK** to generate the MPR file

### Command Line Arguments

You can pass arguments to customize the output:

- `--no-comments`: Suppress comment output for cleaner files
- `--precision=X`: Set coordinate precision (default is 3 decimal places)
- `--workpiece-length=X`: Override workpiece length in mm
- `--workpiece-width=Y`: Override workpiece width in mm
- `--workpiece-thickness=Z`: Override workpiece thickness in mm

Example:
```
--no-comments --precision=2 --workpiece-thickness=18
```

## WoodWOP MPR Output Format

The post processor generates WoodWOP MPR 4.0 format with the following structure:

```
[H
VERSION="4.0"
OP="1"
FM="1"
CB="1"

\ WoodWOP MPR File
\ Generated by FreeCAD
\ Date: 2025-12-21 13:45:00

]1
\ Profile Contour
$KL
X="0.000"
Y="0.000"
$KL
X="100.000"
Y="0.000"
$KA
X="100.000"
Y="100.000"
XM="100.000"
YM="50.000"
R="50.000"

<100 \Werkstck\
LA="800.000"
BR="600.000"
DI="20.000"
AX="0"
AY="0"

<101 \Comment\
KM="Generated by FreeCAD WoodWOP Post Processor"
KM="Date: 2025-12-21 13:45:00"

<105 \Contourfraesen\
EA="1:0"
MDA="TAN"
RK="WRKL"
EE="1:1"
MDE="TAN_AB"
EM="1"
RI="1"
TNO="101"
SM="0"

!
```

## MPR Format Elements

### Data Head `[H`
Contains version information and machine settings.

### Contour Elements `]n`
Defines contours using:
- `$KL` - Line element with endpoint X, Y
- `$KA` - Arc element with endpoint X, Y, center XM, YM, and radius R
- `$KP` - Point element (not yet implemented)

### Processing Macros

#### `<100 \Werkstck\` - Workpiece
Defines workpiece dimensions:
- `LA` - Length (X dimension)
- `BR` - Width (Y dimension)
- `DI` - Thickness (Z dimension)
- `AX`, `AY` - Offsets

#### `<102 \BohrVert\` - Vertical Drilling
Vertical drilling operations:
- `XA`, `YA` - Position
- `TI` - Depth
- `TNO` - Tool number
- `BM` - Drilling mode

#### `<105 \Contourfraesen\` - Contour Milling
Routing along a contour:
- `EA` - Start element (contour:element)
- `EE` - End element
- `MDA`, `MDE` - Approach/exit modes
- `RK` - Reference edge
- `TNO` - Tool number

#### `<107 \Pocket\` - Pocket Milling
Pocket milling inside a contour:
- `EA` - Contour reference
- `TNO` - Tool number

## Supported FreeCAD Operations

| FreeCAD Operation | WoodWOP Macro | Description |
|-------------------|---------------|-------------|
| Profile / Contour | Contourfraesen | Routes along contour |
| Drilling | BohrVert | Vertical drilling |
| Pocket | Pocket | Pocket milling |

## How It Works

1. **Contour Extraction**: The post processor analyzes G-code commands (G1, G2, G3) and converts them into WoodWOP contour elements (KL lines, KA arcs)

2. **Operation Mapping**: FreeCAD Path operations are mapped to appropriate WoodWOP macros:
   - Profile operations → Contourfraesen
   - Drilling operations → BohrVert
   - Pocket operations → Pocket

3. **Workpiece Auto-detection**: Workpiece dimensions are automatically read from the FreeCAD Job's Stock object

4. **Tool Management**: Tool numbers are extracted from ToolController objects and included in each operation

## Coordinate System

- MPR format uses mm as the standard unit
- X, Y, Z coordinates follow the WoodWOP coordinate system
- Contour elements are defined in the X-Y plane
- Z depth is specified in individual operations

## Limitations

- Currently supports basic contour elements (lines and arcs)
- Corner rounding (KR) and chamfers (KF) not yet implemented
- Some advanced WoodWOP macros not yet supported
- Complex 3D surfaces may need manual optimization
- Always verify generated MPR files with WoodWOP before running on machine

## Testing

Before running on your CNC machine:

1. Generate a simple test path in FreeCAD (e.g., a rectangular profile)
2. Export using this post processor
3. Open the generated .mpr file in WoodWOP
4. Verify the contours and operations appear correctly
5. Simulate in WoodWOP
6. Run on machine with test material

## Troubleshooting

**Post processor doesn't appear in dropdown:**
- Verify the file is in the correct directory
- File must be named `woodwop_post.py`
- Restart FreeCAD completely
- Check file permissions (must be readable)

**Contours not appearing correctly:**
- Check that your FreeCAD Path uses supported operations
- Verify coordinate system settings in FreeCAD Job
- Ensure paths contain actual geometry (not just rapid moves)

**Workpiece dimensions incorrect:**
- Use command line arguments to override dimensions
- Check FreeCAD Job Stock settings
- Verify units are set correctly

**Tool numbers not correct:**
- Ensure ToolController is assigned to each operation
- Tool number defaults to 101 if not found
- Check Tool Library settings

## MPR Format Reference

This post processor implements the WoodWOP MPR Format 4.0 specification as documented in:
- Document: 9-080-42-7190-D00
- Valid from woodWOP Version 5.0.924.0

Key format features:
- `\` = Comment line
- `[H` = Data head
- `]n` = Contour n
- `$KL`, `$KA` = Contour elements
- `<nnn` = Processing macro with ID nnn
- `!` = End of file

## Contributing

Feel free to extend this post processor:

- Add support for additional WoodWOP macros (horizontal drilling, grooving, etc.)
- Implement corner rounding (KR) and chamfer (KF) elements
- Add support for more FreeCAD Path operations
- Improve contour optimization

## License

This post processor is provided as-is for use with FreeCAD and HOMAG CNC machines.

## Support

- **FreeCAD Path questions**: https://forum.freecad.org/
- **WoodWOP programming**: Consult your HOMAG machine documentation
- **MPR format**: See included `mpr4x_format_us (1).txt` specification

## Version History

- **2.0.0** (2025-12-21): Complete rewrite for MPR 4.0 format
  - Implemented proper MPR format structure
  - Added contour element generation (KL, KA)
  - Added WoodWOP macros: Werkstck, BohrVert, Contourfraesen, Pocket
  - Auto-detection of workpiece dimensions
  - Support for drilling, profiling, and pocket operations

- **1.0.0** (2025-12-21): Initial release (deprecated)
  - Basic G-code style output
