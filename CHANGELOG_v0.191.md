# Отчёт о версии v0.191

## Дата: 2025-01-28

## Основные изменения

### Исправление ключа `/log`

**Проблема:**
Ключ `/log` не работал корректно - лог-файл создавался всегда, даже без указания ключа `/log`.

**Причина:**
1. `FilenameGenerator` создавался в `Command.py` после вызова `export()`, но проверка флага `ENABLE_VERBOSE_LOGGING` происходила до того, как флаг был установлен.
2. Лог-файл создавался для всех пост-процессоров, а не только для `woodwop`.
3. Парсинг аргументов происходил после сброса флагов, что приводило к потере значения флага.

**Решение:**

1. **Парсинг флагов перенесён в начало `export()`**:
   - Флаги (`/log`, `/report`, `/nc`, `/p_c`) теперь парсятся и устанавливаются в самом начале функции `export()`.
   - Это гарантирует, что флаги установлены до создания `FilenameGenerator` в `Command.py`.

2. **Проверка пост-процессора в `_init_log_file()`**:
   - Добавлена проверка имени пост-процессора из Job.
   - Лог-файл создаётся только если пост-процессор - `woodwop`.
   - Для других пост-процессоров лог-файл не создаётся.

3. **Улучшена проверка флага `ENABLE_VERBOSE_LOGGING`**:
   - Добавлено явное преобразование в `bool()` для надёжности.
   - Добавлены debug-сообщения для отладки.
   - Улучшена обработка ошибок.

## Технические детали

### Изменённые файлы:
- `woodwop post/woodwop_post.py` - парсинг флагов перенесён в начало функции
- `src/Mod/CAM/Path/Post/Utils.py` - добавлена проверка пост-процессора и улучшена проверка флага
- `.pixi/envs/default/Mod/CAM/Path/Post/Utils.py` - синхронизация

### Порядок выполнения:

**До исправления:**
1. `export()` вызывается
2. Флаги сбрасываются в `False`
3. `FilenameGenerator` создаётся (проверяет флаг - он `False`)
4. Парсинг аргументов (флаг устанавливается в `True`, но уже поздно)

**После исправления:**
1. `export()` вызывается
2. Флаги сбрасываются в `False`
3. **Парсинг аргументов (флаги устанавливаются)**
4. `FilenameGenerator` создаётся (проверяет флаг - он уже установлен)
5. Лог-файл создаётся только если флаг `True` И пост-процессор `woodwop`

### Код проверки пост-процессора:

```python
# First check if this is woodwop post-processor
postprocessor_name = None
try:
    postprocessor_name = getattr(self.job, 'PostProcessor', None)
    if not postprocessor_name:
        postprocessor_name = Path.Preferences.defaultPostProcessor()
except:
    pass

# Only check for woodwop post-processor
if not postprocessor_name or postprocessor_name.lower() != 'woodwop':
    # Not woodwop post-processor, don't create log file
    self.log_file = None
    self.log_file_path = None
    return
```

## Поведение ключа `/log`

### Без ключа `/log`:
- Лог-файл **НЕ создаётся** для любого пост-процессора
- `ENABLE_VERBOSE_LOGGING = False`
- `FilenameGenerator.log_file = None`

### С ключом `/log` для woodwop:
- Лог-файл **создаётся** только для пост-процессора `woodwop`
- `ENABLE_VERBOSE_LOGGING = True`
- Файл создаётся в папке документа: `freecad_postprocess_YYYYMMDD_HHMMSS.log`

### С ключом `/log` для других пост-процессоров:
- Лог-файл **НЕ создаётся** (проверка пост-процессора возвращает `False`)

## Важные замечания

1. **Перезагрузка FreeCAD обязательна** после изменений в `woodwop_post.py` и `Utils.py`, так как FreeCAD кеширует модули Python.

2. **Порядок парсинга критичен** - флаги должны быть установлены до создания `FilenameGenerator`.

3. **Проверка пост-процессора** гарантирует, что лог-файл создаётся только для `woodwop`, а не для всех пост-процессоров.

## Тестирование

Проверено:
- ✅ Без ключа `/log` лог-файл не создаётся
- ✅ С ключом `/log` для woodwop лог-файл создаётся
- ✅ С ключом `/log` для других пост-процессоров лог-файл не создаётся
- ✅ Флаги устанавливаются до создания `FilenameGenerator`
- ✅ Файлы синхронизированы между `src` и `.pixi/envs/default`

## Следующие шаги

- Продолжить тестирование всех ключей в различных комбинациях
- Убедиться, что все ключи работают корректно после исправления

---

**Примечание:** После изменений необходимо перезагрузить FreeCAD для применения изменений.

